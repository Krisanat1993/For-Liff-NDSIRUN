<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏î‡∏¥‡∏ô/‡∏ß‡∏¥‡πà‡∏á</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Kanit&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body { font-family: 'Kanit', sans-serif; padding: 20px; }
    h2, h4 { text-align: center; }
    .hidden { display: none; }
    #countdownPopup { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index:1000; color:#fff; align-items:center; justify-content:center; }
    #countdownPopup .content { background:#333; padding:20px; border-radius:8px; text-align:center; }
    #selectedImagePreviewContainer { margin-top: 10px; text-align: center; }
    #selectedImagePreview { max-width: 100%; max-height: 200px; border: 1px solid #ddd; margin-top: 5px;}
  </style>
</head>
<body>
  <div class="container mt-5">
    <h2 class="mb-4">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏î‡∏¥‡∏ô/‡∏ß‡∏¥‡πà‡∏á</h2>
    <form id="challenge-form">
      <div class="form-group">
        <label for="team">üî¥ ‡∏ó‡∏µ‡∏°:</label>
        <select id="team" class="form-control" disabled>
          <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</option>
        </select>
      </div>
      <!--<div class="form-group">-->
      <!--  <label for="jocName">üîª ‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏ó‡∏ô. JOC.10:</label>-->
      <!--  <select id="jocName" class="form-control" disabled>-->
      <!--    <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</option>-->
      <!--  </select>-->
      <!--</div>-->
      <div class="form-group">
        <label for="officerName">üîª ‡∏ä‡∏∑‡πà‡∏≠ ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£:</label>
        <input id="officerName" type="text" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ ‡∏™‡∏®‡∏ó.‡∏™‡∏õ‡∏ó." required>
      </div>
      <div class="form-group">
        <label for="distance">üîª ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏î‡∏¥‡∏ô/‡∏ß‡∏¥‡πà‡∏á (‡∏Å‡∏°.):</label>
        <input id="distance" type="number" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏∞‡∏¢‡∏∞ (‡πÄ‡∏ä‡πà‡∏ô 5.2)" step="0.1" required>
      </div>
      <div class="form-group">
        <label for="imageUpload">üñºÔ∏è ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô/‡∏ß‡∏¥‡πà‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):</label>
        <input type="file" id="imageUpload" class="form-control-file" accept="image/*">
        <div id="selectedImagePreviewContainer" class="hidden" style="margin-top: 10px; text-align: center;">
          <p>‡∏†‡∏≤‡∏û‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</p>
          <img id="selectedImagePreview" src="#" alt="Selected Image Preview" style="max-width: 100%; max-height: 200px; border: 1px solid #ddd; margin-top: 5px;"/>
        </div>
      </div>
      <button type="button" id="preview-button" class="btn btn-primary btn-block" onclick="previewData()">‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
    </form>

    <div id="confirmation-container" class="hidden mt-4">
      <h4>‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å</h4>
      <ul id="data-summary" class="list-group mb-3"></ul>
      <div class="d-flex justify-content-around">
        <button class="btn btn-success" onclick="submitData()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á</button>
        <button class="btn btn-secondary" onclick="editData()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      </div>
    </div>

    <div id="success-section" class="hidden mt-4 text-center">
      <h4>‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</h4>
      <p id="successMessage"></p>
      </div>

    <div id="error-message" class="alert alert-danger text-center hidden">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</div>
  </div>

  <div id="countdownPopup">
    <div class="content">
      ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠ <span id="countdownTimer">10</span> ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
    </div>
  </div>

  <script>
// =================================================================
        // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Cache ‡∏Ç‡∏≠‡∏á LIFF
        // =================================================================
        const originalFetch = window.fetch;
        window.fetch = async function(url, options) {
            if (url.toString().startsWith('https://liffsdk.line-scdn.net/') && url.toString().endsWith('.json')) {
                url = url + '?ts=' + Math.random();
            }
            return originalFetch(url, options);
        };
        // =================================================================


    
    const liffId = "2006444340-aWbEZ8z4"; // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const scriptURL = "https://script.google.com/macros/s/AKfycbx8wJRbQlRMuV880LX2jK6LqARQmLYbWmn46AzpkT7eyQa_uk-fXdGsZ1l9wOiZx4etTA/exec"; // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô URL ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    let formData = {};
    let selectedImageFile = null;
    let selectedImageBase64 = null;


    async function populateDropdown(sheet, column, selectId) {
      const sel = document.getElementById(selectId);
      try {
        const res = await fetch(`${scriptURL}?action=getDropdown&sheet=${encodeURIComponent(sheet)}&column=${encodeURIComponent(column)}`);
        if (!res.ok) throw new Error(`Network error: ${res.status} ${res.statusText}`);
        const list = await res.json();
        if (list.status === 'error') throw new Error(list.message || 'Error from Apps Script');
        sel.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>`;
        list.forEach(item => {
          const opt = document.createElement('option');
          opt.value = item;
          opt.text = item;
          sel.appendChild(opt);
        });
      } catch (error) {
        console.error(`Failed to populate dropdown ${selectId}:`, error);
        sel.innerHTML = `<option value="">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>`;
      } finally {
        sel.disabled = false;
      }
    }

    liff.init({ liffId })
      .then(async () => {
        const previewButton = document.getElementById('preview-button');
        previewButton.disabled = true;
        previewButton.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏°...';
        try {
          await Promise.all([
            populateDropdown('‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'A', 'team'),
            // populateDropdown('‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'B', 'jocName')
          ]);
        } catch (error) {
          console.error("Error during dropdown population:", error);
        } finally {
          previewButton.disabled = false;
          previewButton.innerText = '‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á';
        }
      })
      .catch(err => {
        console.error("LIFF Initialization Error:", err);
        document.getElementById('team').innerHTML = `<option value="">‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î LIFF</option>`;
        document.getElementById('jocName').innerHTML = `<option value="">‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î LIFF</option>`;
        document.getElementById('preview-button').innerText = 'LIFF ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤';
        document.getElementById('preview-button').disabled = true;
      });

    document.getElementById('imageUpload').addEventListener('change', function(event) {
      const file = event.target.files[0];
      const previewContainer = document.getElementById('selectedImagePreviewContainer');
      const previewImage = document.getElementById('selectedImagePreview');

      if (file) {
        selectedImageFile = file;
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImage.src = e.target.result;
          selectedImageBase64 = e.target.result;
          previewContainer.classList.remove('hidden');
        }
        reader.readAsDataURL(file);
      } else {
        selectedImageFile = null;
        selectedImageBase64 = null;
        previewImage.src = '#';
        previewContainer.classList.add('hidden');
      }
    });

    function previewData() {
      const team = document.getElementById('team').value;
    //   const jocName = document.getElementById('jocName').value;
      const officerName = document.getElementById('officerName').value;
      const distance = document.getElementById('distance').value;

      if (!team || !distance || parseFloat(distance) <= 0) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô: ‡∏ó‡∏µ‡∏° ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0 (‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏ó‡∏ô. JOC.10 ‡πÅ‡∏•‡∏∞ ‡∏ä‡∏∑‡πà‡∏≠ ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ ‡∏™‡∏®‡∏ó.‡∏™‡∏õ‡∏ó. ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)');
        return;
      }
    //   if (!officerName && !jocName) { // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ
       if (!officerName ) { // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ

        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å "‡∏ä‡∏∑‡πà‡∏≠ ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£" ');
        return;
      }


      formData = {
        Timestamp: new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' }),
        team: team,
        // jocName: jocName || '(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏)',
        officerName: officerName || '(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏)',
        distance: distance,
        imageName: selectedImageFile ? selectedImageFile.name : '(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û)'
      };
      const summary = document.getElementById('data-summary');
      summary.innerHTML = '';
      Object.entries(formData).forEach(([k,v]) => {
        const li = document.createElement('li'); li.className = 'list-group-item';
        let keyDisplay = k;
        // if (k === 'jocName') keyDisplay = '‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏ó‡∏ô. JOC.10';
        if (k === 'officerName') keyDisplay = '‡∏ä‡∏∑‡πà‡∏≠ ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£';
        else if (k === 'team') keyDisplay = '‡∏ó‡∏µ‡∏°';
        else if (k === 'distance') keyDisplay = '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.)';
        else if (k === 'imageName') keyDisplay = '‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
        else if (k === 'Timestamp') keyDisplay = '‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';

        li.innerHTML = `<strong>${keyDisplay}:</strong> ${v}`;
        summary.appendChild(li);
      });
      document.getElementById('challenge-form').classList.add('hidden');
      document.getElementById('confirmation-container').classList.remove('hidden');
    }

    function editData() {
      document.getElementById('confirmation-container').classList.add('hidden');
      document.getElementById('challenge-form').classList.remove('hidden');
      document.getElementById('error-message').classList.add('hidden');
    }

    async function fetchSummarySheetData() {
        console.log("Fetching summary sheet data...");
        try {
            const res = await fetch(`${scriptURL}?action=getSummaryResults`); // Ensure GAS has this action
            if (!res.ok) throw new Error(`Network error fetching summary: ${res.status} ${res.statusText}`);
            const result = await res.json();
            if (result.status !== 'success') throw new Error(result.message || 'Failed to fetch summary data from sheet');
            console.log("Summary sheet data fetched:", result.data);
            return result.data;
        } catch (error) {
            console.error("Error fetching summary sheet data:", error);
            return null; // Return null on error so submitData can handle it
        }
    }

    async function submitData() {
      const confirmationButton = document.querySelector('#confirmation-container .btn-success');
      if (confirmationButton) confirmationButton.disabled = true;
      document.getElementById('error-message').classList.add('hidden');
      document.getElementById('successMessage').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
      document.getElementById('success-section').classList.remove('hidden');
      document.getElementById('confirmation-container').classList.add('hidden');

      let lineMessagesToSend = []; // Initialize here

      try {
        // 1. Prepare Text Data for Google Sheet
        const textDataForSheet = {
            Timestamp: formData.Timestamp,
            team: formData.team,
            // jocName: formData.jocName,
            officerName: formData.officerName,
            distance: formData.distance
        };

        const payloadForSheet = new FormData();
        payloadForSheet.append('action', 'submitText');
        payloadForSheet.append('textData', JSON.stringify(textDataForSheet));

        console.log("Submitting text data to sheet:", textDataForSheet);
        const resText = await fetch(scriptURL, { method: 'POST', body: payloadForSheet });
        const resultText = await resText.json();
        console.log("Response from submitText:", resultText);

        if (resultText.status !== 'success') {
          throw new Error(resultText.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡∏µ‡∏ï');
        }
        document.getElementById('successMessage').innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏•‡∏á‡∏ä‡∏µ‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ...';

        // 2. Fetch Summary Data from "‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•" sheet
        const summarySheetData = await fetchSummarySheetData();

        // 3. Construct the main text message for LINE
        let detailedLineMessage = "üèÉüèª‚Äç‚ôÇÔ∏èüèÉüèª‚Äç‚ôÇÔ∏è ‡∏Å‡∏≤‡∏£‡∏™‡∏∞‡∏™‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏î‡∏¥‡∏ô/‡∏ß‡∏¥‡πà‡∏á:\n\n";
        detailedLineMessage += `üî¥ ‡∏ó‡∏µ‡∏°:  ${formData.team}\n`;
        // detailedLineMessage += `üîª‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏ó‡∏ô. JOC.10:  ${formData.jocName}\n`;
        detailedLineMessage += `üîª‡∏ä‡∏∑‡πà‡∏≠ ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£:  ${formData.officerName}\n`;
        detailedLineMessage += `üîª‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏î‡∏¥‡∏ô/‡∏ß‡∏¥‡πà‡∏á ‡∏Å‡∏°.:  ${formData.distance}\n\n`;

        detailedLineMessage += "üèÜ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• Run Challenge:\n";
        if (summarySheetData) {
            detailedLineMessage += `üéØ ‡∏£‡∏∞‡∏¢‡∏∞ Challenge: ${summarySheetData.challengeGoal !== undefined && summarySheetData.challengeGoal !== null ? summarySheetData.challengeGoal : 'N/A'} ‡∏Å‡∏°.\n`;
detailedLineMessage += `üìà ‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏∞‡∏™‡∏°: ${
  summarySheetData.totalAccumulated !== undefined &&
  summarySheetData.totalAccumulated !== null &&
  !isNaN(parseFloat(summarySheetData.totalAccumulated))
    ? parseFloat(summarySheetData.totalAccumulated).toFixed(2)
    : 'N/A'
} ‡∏Å‡∏°.\n\n`;            if (summarySheetData.teams && summarySheetData.teams.length > 0) {
                summarySheetData.teams.forEach(team => {
                    if (team.name) { // Only add team info if name exists
                        detailedLineMessage += `üîª ‡∏ó‡∏µ‡∏° ${team.name || 'N/A'}\n`;
detailedLineMessage += `    ‚Ä¢ ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: ${
  team.distance !== undefined &&
  team.distance !== null &&
  !isNaN(parseFloat(team.distance))
    ? parseFloat(team.distance).toFixed(2)
    : 'N/A'
} ‡∏Å‡∏°.\n`;                        detailedLineMessage += `    ‚Ä¢ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö: ${team.rank !== undefined && team.rank !== null ? team.rank : 'N/A'}\n\n`;
                    }
                });
            } else {
                detailedLineMessage += "   (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°‡πÉ‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•)\n\n";
            }
        } else {
            detailedLineMessage += "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ\n\n";
        }

        detailedLineMessage += "‚ÄºÔ∏è‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡πà‡∏á‡∏™‡∏∞‡∏™‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏î‡∏¥‡∏ô/‡∏ß‡∏¥‡πà‡∏á: https://liff.line.me/2006444340-aWbEZ8z4\n\n";

        lineMessagesToSend.push({ type: 'text', text: detailedLineMessage });

        // 4. If an image was selected, upload it and add to messages
        let uploadedImageUrl = null;
        if (selectedImageFile && selectedImageBase64) {
          document.getElementById('successMessage').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏´‡πâ‡∏≤‡∏°‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
          
          const imagePayload = new URLSearchParams();
          imagePayload.append('action', 'uploadImage');
          imagePayload.append('imageData', selectedImageBase64);
          imagePayload.append('fileName', selectedImageFile.name);
          imagePayload.append('mimeType', selectedImageFile.type);
          imagePayload.append('timestamp', formData.Timestamp);

          console.log("Uploading image data (first 100 chars of base64):", selectedImageBase64.substring(0,100));
          const resImage = await fetch(scriptURL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: imagePayload.toString()
          });
          const resultImage = await resImage.json();
          console.log("Response from uploadImage:", resultImage);

          if (resultImage.status === 'success' && resultImage.imageUrl) {
            uploadedImageUrl = resultImage.imageUrl;
            lineMessagesToSend.push({
              type: 'image',
              originalContentUrl: uploadedImageUrl,
              previewImageUrl: uploadedImageUrl
            });
            document.getElementById('successMessage').innerHTML = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß<br><strong>‡∏†‡∏≤‡∏û‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á LINE</strong>`;
          } else {
            let imageErrorMsg = resultImage.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ';
             // Modify the first text message to include image upload failure
            lineMessagesToSend[0].text += `\n\n(‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${imageErrorMsg})`;
            document.getElementById('successMessage').innerHTML = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß<br><strong style="color:red;">‡πÅ‡∏ï‡πà‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${imageErrorMsg}</strong>`;
          }
        } else {
            document.getElementById('successMessage').innerHTML = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß<br>(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û)`;
        }

        // 5. Send messages to LINE
        if (liff.isInClient() && lineMessagesToSend.length > 0) {
          console.log("Sending messages to LINE:", JSON.stringify(lineMessagesToSend));
          await liff.sendMessages(lineMessagesToSend);
        } else if (!liff.isInClient()) {
            alert("‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡πÅ‡∏≠‡∏û LINE ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ä‡∏µ‡∏ï‡πÅ‡∏•‡πâ‡∏ß (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)\n" + JSON.stringify(lineMessagesToSend, null, 2));
        }

        document.getElementById('challenge-form').classList.add('hidden');
        // Update success message to reflect everything is done.
        let finalSuccessMsg = "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!\n";
        finalSuccessMsg += `‡∏ó‡∏µ‡∏°: ${formData.team}, ‡∏ä‡∏∑‡πà‡∏≠ ‡∏Ç‡∏£‡∏Å.: ${formData.officerName}, ‡∏£‡∏∞‡∏¢‡∏∞: ${formData.distance} ‡∏Å‡∏°.`;
        if(uploadedImageUrl) finalSuccessMsg += "\n‡∏†‡∏≤‡∏û‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß";
        else if(selectedImageFile) finalSuccessMsg += "\n‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤";
        else finalSuccessMsg += "\n(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡∏ö‡∏†‡∏≤‡∏û)";
        document.getElementById('successMessage').innerHTML = finalSuccessMsg.replace(/\n/g, "<br>");


        setTimeout(() => {
          if (liff.isInClient()) {
            liff.closeWindow();
          }
        }, 2000); // Increased timeout to allow user to read final message

      } catch (e) {
        console.error('Error submitting data:', e);
        document.getElementById('success-section').classList.add('hidden');
        document.getElementById('error-message').innerText = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${e.message}. ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ GAS.`;
        document.getElementById('error-message').classList.remove('hidden');
        document.getElementById('confirmation-container').classList.add('hidden');
        document.getElementById('challenge-form').classList.remove('hidden');
      } finally {
        if (confirmationButton) confirmationButton.disabled = false;
      }
    }
  </script>
</body>
</html>
